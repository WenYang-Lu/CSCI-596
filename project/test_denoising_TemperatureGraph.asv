clear all; close all;
rng(7); % random seed

%% Graph and Signal
load("data/Temperature_Graph.mat");

A=double(full(G.W)); % adjacency matrix
lmaxA=eigs(A,1); [VA,lamA]=eig(A); lamA=diag(lamA);

L=diag(sum(A))-A; % Laplacian matrix
lmaxL=eigs(L,1); [VL,lamL]=eig(L); lamL=diag(lamL); G.L=L; G.lmax=lmaxL;

N=G.N; % total number of graph nodes
x=(G.maxTemp+G.minTemp)/2; % graph signal: average temperature

%% Ideal filter
fcL=0.75; %cut-off frequency
fun_gL= @(lam) double(lam<=fcL*lmaxL);
fun_gA= @(lam) double(lam>=-(fcL-0.5)*2*lmaxA);

%% Chebyshev filter approximation
M=10; % filter's polynomial order
c_cheby=gsp_cheby_coeff(G,fun_gL,M);

%% Noisy signal setting
mu=0; 
% sig=sqrt(0.25);
% sig=sqrt([0.25,0.2,0.15,0.1,0.05]); 
% sig=sqrt([2.5,2.0,1.5,1.0,0.5]); 
% sig=sqrt([5,4,3,2,1]);
sig=sqrt([8.0, 6.5, 5.0, 3.5, 2.0]);
% sig=sqrt([7, 5.5, 4, 2.5]);

S=length(sig);
xn=zeros(N,S); %noisy signal
for s=1:S
    xn(:,s)=x+sig(s)*randn(N,1)+mu;
end

%% filtering process
MSE_ori=zeros(1,S); SNR_ori=zeros(1,S);
MSE_chebyL=zeros(1,S); SNR_chebyL=zeros(1,S); runtime_chebyL=zeros(1,S);
MSE_chebyA=zeros(1,S); SNR_chebyA=zeros(1,S); runtime_chebyA=zeros(1,S);

for s=1:S
    MSE_ori(s)=immse(x,xn(:,s)); % MSE_ori=norm(fn-f).^2/N;
    SNR_ori(s)=snr(x,xn(:,s)-x); % SNR_ori=20*log10(norm(f)/norm(fn-f));

    % chebyshev filter
    tic;
    y_chebyL=gsp_cheby_op(G,c_cheby,xn(:,s)); 
    runtime_chebyL(s)=toc; 
    tic;
    y_chebyA=myGraphCheby_op(A,c_cheby/2,xn(:,s),[-lmaxA,lmaxA]); 
    runtime_chebyA(s)=toc;
        
    % SNR calculation
    MSE_chebyL(s)=norm(y_chebyL-x)/norm(x); SNR_chebyL(s)=snr(x,y_chebyL-x);
    MSE_chebyA(s)=norm(y_chebyA-x)/norm(x); SNR_chebyA(s)=snr(x,y_chebyA-x);
end

% runtime (millisecond)
time_chebyL=sum(runtime_chebyL)/S*1000;
time_chebyA=sum(runtime_chebyA)/S*1000;

%% plot filter response --- L
figure('Position', [550, 360, 500, 300]);  hold on; 
xlim([0,lmaxL]); ylim([-0.2,1.2]);
xlabel('Graph frequency \lambda'); title('Magnitude Response');

num_grid=500; 
lam_grid=linspace(0,lmaxL,num_grid)';
%%%%%% ideal %%%%%%
plot(lam_grid,fun_gL(lam_grid),'k','Linewidth',2); 
%%%%%% chebyshev %%%%%%
plot(lam_grid,gsp_cheby_eval(lam_grid,c_cheby,[0,lmaxL]),'linewidth',2);

legend({'Ideal','Chebyshev'},'fontsize',14,'Location','southwest');
set(gca,'Fontsize',14');
screen2tif('FilterRespL');

%% plot filter response --- A
figure('Position', [550, 360, 500, 300]);  hold on; 
xlim([-1,1]); ylim([-0.2,1.2]);
xlabel('Graph frequency \lambda'); title('Magnitude Response');

num_grid=500;
lam_grid=linspace(-lmaxA,lmaxA,num_grid)';

%%%%%% ideal %%%%%%
plot(lam_grid,fun_gA(lam_grid),'k','Linewidth',2);
%%%%%% chebyshev %%%%%%
plot(lam_grid,mycheby_eval(lam_grid,c_cheby/2,[-lmaxA,lmaxA],'chebyA'),'linewidth',2);
legend({'Ideal','Chebyshev [6]'},'fontsize',14,'Location','southeast');
set(gca,'Fontsize',14');
screen2tif('FilterRespA');
%% plot approximation error
% arange=[0,lmaxL];
% figure; hold on;
% plot(w/pi*lmaxL,gsp_cheby_eval(lam_grid,c_cheby,arange)-fun_g(lam_grid),'linewidth',2);
% plot(w/pi*lmaxL,abs(h)-fun_g(lam_grid),'linewidth',2);

%% plot signal spectrum  --- L
figure('Position', [550, 360, 500, 300]);  hold on; 
c=get(groot,'DefaultAxesColorOrder');
plot(lamL,abs(VL\x),'Linewidth',2,'Color',c(1,:)); 
ylim([0,20]);
xlabel('Graph frequency \lambda'); title('Magnitude of Spectrum');
set(gca,'FontSize',14);
screen2tif('OriSignal_SpecL');

%%  plot signal spectrum  --- A
figure('Position', [550, 360, 500, 300]);  hold on; 
c=get(groot,'DefaultAxesColorOrder');
plot(lamA,abs(VA\x),'Linewidth',2,'Color',c(1,:)); 
ylim([0,80]);
xlabel('Graph frequency \lambda'); title('Magnitude of Spectrum');
set(gca,'FontSize',14);
screen2tif('OriSignal_SpecA');

%% plot graph
tx=[0,-0.065,1,0.5];
figure('Position', [550, 360, 350, 250]);   hold on; 
param.colorbar=0;
gsp_plot_signal(G,x,param);
t=colorbar('South','fontsize',13,'AxisLocation','out');
% t.Position(1:2)=t.Position(1:2)+tx(1:2);
t.Position(3:4)=t.Position(3:4).*tx(3:4);
caxis([min(x),max(x)]);
screen2tif('OriSignal');


figure('Position', [550, 360, 350, 250]);   hold on; 
param.colorbar=0;
gsp_plot_signal(G,xn(:,s),param);
t=colorbar('South','fontsize',13,'AxisLocation','out');
% t.Position(1:2)=t.Position(1:2)+tx(1:2);
t.Position(3:4)=t.Position(3:4).*tx(3:4);
caxis([min(x),max(x)]);
screen2tif('Noisy Signal');

%%  plot graph signal --- L
% figure;
% gsp_plot_signal(G,y_chebyL);
% figure;
% gsp_plot_signal(G,y_ScL);
figure('Position', [550, 360, 350, 250]);   hold on; 
param.colorbar=0;
gsp_plot_signal(G,real(y_chebyL),param);
t=colorbar('South','fontsize',13,'AxisLocation','out');
% t.Position(1:2)=t.Position(1:2)+tx(1:2);
t.Position(3:4)=t.Position(3:4).*tx(3:4);
% t.Position(2)=t.Position(1)-0.06;
% t.Position(4)=t.Position(4)*0.7;
caxis([min(x),max(x)]);
screen2tif('Recon Signal Bil sig2');
%% plot graph signal --- A
% figure;
% gsp_plot_signal(G,y_chebyA);



